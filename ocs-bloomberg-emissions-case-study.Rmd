---
title: "Open Case Studies : CO2 Emmissions Over Time"
author: "Michael Ontiveros, Carrie Wright, PhD."
css: style.css
output:
  html_document:
    self_contained: yes
    code_download: yes
    highlight: tango
    number_sections: no
    theme: cosmo
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

<style>
#TOC {
  background: url("https://opencasestudies.github.io/img/logo.jpg");
  background-size: contain;
  padding-top: 240px !important;
  background-repeat: no-repeat;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, comment = NA, echo = TRUE,
                      message = FALSE, warning = FALSE, cache = FALSE,
                      fig.align = "center", out.width = '90%')
library(here)
library(knitr)
```

#### {.outline }
```{r, echo = FALSE, out.width = "800 px"}
knitr::include_graphics(here::here("img", "mainplot.png"))
```

####

## {.disclaimer_block}

**Disclaimer**: The purpose of the [Open Case Studies](https://opencasestudies.github.io){target="_blank"} project is **to demonstrate the use of various data science methods, tools, and software in the context of messy, real-world data**. A given case study does not cover all aspects of the research process, is not claiming to be the most appropriate way to analyze a given data set, and should not be used in the context of making policy decisions without external consultation from scientific experts. 

## **Motivation**
*** 

This analysis explores how different countries have contributed to Carbon Dioxide (CO2) emissions over time and how CO2 emission rates may relate to increasing global temperatures and increased rates of natural disaster and storms. This report provides a basis for the motivation: https://www.epa.gov/report-environment/greenhouse-gases.


CO2 makes up the largest proportion of greenhouse gas emissions in the United States:


```{r, echo = FALSE, out.width="500px"}
knitr::include_graphics(here::here("img", "emissions.jpg"))
```

A variety of sources and sectors contribute to greenhouse gas emissions:


```{r, echo = FALSE, out.width="600px"}
knitr::include_graphics(here::here("img", "sector.png"))
```

So why should we pay attention to greenhouse gases?

According to the [US Environmental Protection Agency (EPA) Inventory of U.S. Greenhouse Gas Emissions and Sinks 2020 Report](https://www.epa.gov/ghgemissions/inventory-us-greenhouse-gas-emissions-and-sinks): 

> Greenhouse gases absorb infrared radiation, thereby trapping heat in the atmosphere and making the planet warmer. The most important greenhouse gases directly emitted by humans include carbon dioxide (CO2), methane (CH4), nitrous oxide (N2O), and several fluorine-containing halogenated substances. Although CO2, CH4, and N2O occur naturally in the atmosphere, human activities have changed their atmospheric concentrations. From the pre- industrial era (i.e., ending about 1750) to 2018, concentrations of these greenhouse gases have increased globally by 46, 165, and 23 percent, respectively (IPCC 2013; NOAA/ESRL 2019a, 2019b, 2019c).

There are many signs that our planet is experiencing warmer temperatures:

```{r, echo = FALSE, out.width="600px"}
knitr::include_graphics(here::here("img", "warming.png"))
```

The connection between greenhouse gas levels and global temperatures and the influence of increased global temperatures on human health are motivated by these reports:

#### {.reference_block}

Melillo, J.M., T.C. Richmond, and G.W. Yohe (eds.). 2014. Climate change impacts in the United States: The third National Climate Assessment. U.S. Global Change Research Program.  

2020. “Inventory of US Greenhouse Gas Emissions and Sinks: 1990--2018.” EPA 430-R-20-002, Tech. Rep. https://www.epa.gov/ghgemissions/inventory-us-greenhouse-gas-emissions-and-sinks.


####

The National Climate Assessment Report states that:

> Heat-trapping gases already in the atmosphere have committed us to a hotter future with more climate-related impacts over the next few decades. The magnitude of climate change beyond the next few decades depends primarily on the amount of heat-trapping gases that human activities emit globally, now and in the future

See [here](https://www.epa.gov/report-environment/greenhouse-gases) and [here](https://world101.cfr.org/global-era-issues/climate-change/climate-change-adaptations) for more information.

## **Main Questions**
*** 

#### {.main_question_block}
<b><u> Our main question: </u></b>

1) How have global CO2 emission rates changed over time? In particular for the US, and how does the US compare to other countries? 
2) Are US CO2 emissions, global temperatures, and US storm rates associated? 

####

## **Learning Objectives** 
*** 

In this case study, we will explore CO2 emission data from around the world. We will also focus on the US specifically to evaluate patterns of temperatures and storm activity. This case study will particuarly focus on visualizations of patterns over time. We will especially focus on using packages and functions from the [`Tidyverse`](https://www.tidyverse.org/){target="_blank"}, such as `plotly`and `gganimate`. The tidyverse is a library of packages created by RStudio. While some students may be familiar with previous R programming packages, these packages make data science in R especially efficient.


*** 


We will begin by loading the packages that we will need:

```{r}
library(here)
library(tidyverse)
library(readxl)
library(plotly)
library(gganimate)
library(RColorBrewer)
```


 Package   | Use                                                                         
---------- |-------------
[here](https://github.com/jennybc/here_here){target="_blank"}       | to easily load and save data
[tidyverse](https://www.tidyverse.org/packages/) | to wrangle the data and create ggplot2 plots
[readxl](https://readxl.tidyverse.org/) | to import the Excel file data
[plotyly](https://plotly.com/r/) | to make the visualizations
[gganimate](https://gganimate.com/) | to make the plots interactive
[RColorBrewer](https://cran.r-project.org/web/packages/RColorBrewer/index.html) | to have greater control over the color in our plots

The first time we use a function, we will use the `::` to indicate which package we are using. Unless we have overlapping function names, this is not necessary, but we will include it here to be informative about where the functions we will use come from.


## **Context**
*** 

Greenhouse gas emissions are due to both natural processes and antropogenic (human-derived) activities. 

These emissions are one of the contributing factors to rising global temperatures, which can have a great influence on [public health](https://www.epa.gov/climate-indicators/understanding-connections-between-climate-change-and-human-health) as illustrated in the following image:

```{r, echo = FALSE, out.width="800px"}
knitr::include_graphics(here::here("img", "health.png"))
```

> Gases in the atmosphere can contribute to climate change both directly and indirectly. Direct effects occur when the gas itself absorbs radiation. Indirect radiative forcing occurs when chemical transformations of the substance produce other greenhouse gases, when a gas influences the atmospheric lifetimes of other gases, and/or when a gas affects atmospheric processes that alter the radiative balance of the earth (e.g., affect cloud formation or albedo). The IPCC developed the Global Warming Potential (GWP) concept to compare the ability of a greenhouse gas to trap heat in the atmosphere relative to another gas.
The GWP of a greenhouse gas is defined as the ratio of the accumulated radiative forcing within a specific time horizon caused by emitting 1 kilogram of the gas, relative to that of the reference gas CO2 (IPCC 2013). Therefore GWP-weighted emissions are provided in million metric tons of CO2 equivalent (MMT CO2 Eq.)


 CO2 is actually the least capable of the greehouse gases for trapping heat:

```{r, echo = FALSE, out.width="800px"}
knitr::include_graphics(here::here("img", "GWP.png"))
```

However, because CO2 is so much more abundant and stays in the atmosphere so much longer than the other greenhouse gases, it has been the largest contributor to global warming.

See [here](https://www.ucsusa.org/resources/why-does-co2-get-more-attention-other-gases#:~:text=CO2%20sticks%20around,oxide%20(N2O).)
for more details.


Furthermore, rizing CO2 levels also influence ocean acidity:

```{r, echo = FALSE, out.width="500px"}
knitr::include_graphics(here::here("img", "oceans.png"))
```

This makes it difficult for organisms to maintian their shells or skeletons that are made of calcium carbonate, thus making it more difficult for these organisms to survive and impacting their role in the ecosystem and food chain. 


Furthermore, greenhouse gas emissions are believed to influence storm rates. 

Indeed events with high levels of precipitation which can induce flooding and property damage are generally increasing around the country:

```{r, echo = FALSE, out.width="500px"}
knitr::include_graphics(here::here("img", "storms.png"))
```

https://www.epa.gov/climate-indicators/cherry-blossoms

## Wrangling the data

### Global Data

### Yearly CO~2~ Emissions, 1000 Metric Tonnes 

#### Source

[Click here to be redirected to the source from which we obtained this dataset](https://www.gapminder.org/data/)

[Click here to be redirected to the direct source for this dataset](https://cdiac.ess-dive.lbl.gov/)

#### Code

```{r}
library(here)
CO2_emissions <- read_excel(here("docs/yearly_co2_emissions_1000_tonnes.xlsx"))

head(CO2_emissions)

CO2_emissions <- CO2_emissions %>%
  gather(key = Year, value = Emissions, -country) %>%
  rename(Country=country) %>%
  mutate(Emissions = Emissions/1000) %>%
  rename(`CO2 Emissions (Mg)`=Emissions)

sapply(CO2_emissions, class)

CO2_emissions$Year <- as.numeric(CO2_emissions$Year)

summary(CO2_emissions$Year)

ggplot(CO2_emissions, aes(x=Year, y=`CO2 Emissions (Mg)`, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country CO"[2]*" Emissions per Year , 1751-2014"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Emissions (1M Metric Tonnes)")

CO2_world<-CO2_emissions %>%
  group_by(Year) %>%
  summarise(`CO2 Emissions (Mg)` = sum(`CO2 Emissions (Mg)`, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=`CO2 Emissions (Mg)`)) +
  geom_line() + 
  labs(title = expression("World CO"[2]*" Emissions per Year , 1751-2014"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Emissions (1M Metric Metric Tonnes)")
CO2_world
```

### Yearly Growth in GDP per Capita

#### Source

[Click here to be redirected to the source from which we obtained this dataset](https://www.gapminder.org/data/)

[Click here to be redirected to the direct source for this dataset](https://data.worldbank.org/indicator/NY.GDP.PCAP.KD.ZG)

#### Code 

**Michael** Need to determine units for this 

```{r}
gdp_growth <- read_xlsx(here("docs/gdp_per_capita_yearly_growth.xlsx"))

head(gdp_growth)

gdp_growth <- gdp_growth %>%
  gather(key = Year, value = gdp_growth, -country) %>%
  rename(Country=country) %>%
  rename(`GDP Growth/Capita (%)` = gdp_growth) %>%
  filter(complete.cases(.))

sapply(gdp_growth, class)

gdp_growth$Year <- as.numeric(gdp_growth$Year)

summary(gdp_growth$Year)

ggplot(gdp_growth, aes(x=Year, y=`GDP Growth/Capita (%)`, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country GDP Growth per Capita per Year (Annual %), 1801-2019"),
       caption = expression("Limited to reporting countries")) + 
  ylab("GDP Growth per Capita (Annual %)")

gdp_growth %>%
  group_by(Year) %>%
  summarise(`GDP Growth/Capita (%)` = mean(`GDP Growth/Capita (%)`, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=`GDP Growth/Capita (%)`)) +
  geom_line() + 
  labs(title = expression("Mean Country GDP Growth per Capita per Year (Annual %), 1801-2019"),
       caption = expression("Limited to reporting countries")) + 
  ylab("GDP Growth per Capita (Annual %)")
```

### Energy Use per Person

#### Source

[Click here to be redirected to the source from which we obtained this dataset](https://www.gapminder.org/data/)

[Click here to be redirected to the direct source for this dataset](https://data.worldbank.org/indicator/EG.USE.PCAP.KG.OE)

#### Code

```{r}
energy_use <- read_xlsx(here("docs/energy_use_per_person.xlsx"))

head(energy_use)

energy_use <- energy_use %>%
  gather(key = Year, value = energy_use, -country) %>%
  rename(Country=country) %>%
  rename(`Energy Use (kg, oil-eq./capita)` = energy_use)

sapply(energy_use, class)

energy_use$Year <- as.numeric(energy_use$Year)

summary(energy_use$Year)

ggplot(energy_use, aes(x=Year, y=`Energy Use (kg, oil-eq./capita)`, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country Energy Use (kg of Oil Equivalent per Capita), 1960-2015",),
       caption = expression("Limited to reporting countries")) + 
  ylab("Energy Use (kg of Oil Equivalent per Capita)")

energy_use %>%
  group_by(Year) %>%
  summarise(`Energy Use (kg, oil-eq./capita)` = sum(`Energy Use (kg, oil-eq./capita)`, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=`Energy Use (kg, oil-eq./capita)`)) +
  geom_line() + 
  labs(title = expression("Worldwide Energy Use (kg of Oil Equivalent per Capita), 1960-2015"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Energy Use (kg of Oil Equivalent per Capita)")
```

### Crude Mortality Rate

#### Source

[Click here to be redirected to the direct source for this dataset](https://data.worldbank.org/indicator/SP.DYN.CDRT.IN)

#### Code

```{r}
mortality <- read_xls(here("docs/API_SP.DYN.CDRT.IN_DS2_en_excel_v2_804384.xls"))

head(mortality)

colnames(mortality) <- mortality[3,]
mortality <- mortality[-c(1:3),]

mortality <- mortality %>%
  select(-`Country Code`,
         -`Indicator Name`,
         -`Indicator Code`) %>%
  rename(Country="Country Name") %>%
  gather(key = Year, value = `Deaths/1000 People`, -Country)

sapply(mortality, class)

mortality$Year <- as.numeric(mortality$Year)
mortality$`Deaths/1000 People` <- as.numeric(mortality$`Deaths/1000 People`)

summary(mortality$Year)

ggplot(mortality, aes(x=Year, y=`Deaths/1000 People`, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country Crude Mortality Rate (per 1000 Persons), 1960-2019",),
       caption = expression("Limited to reporting countries")) + 
  ylab("Crude Mortality Rate (per 1000 Persons)")

mortality %>%
  group_by(Year) %>%
  summarise(`Deaths/1000 People` = mean(`Deaths/1000 People`, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=`Deaths/1000 People`)) +
  geom_line() + 
  labs(title = expression("Mean Country Crude Mortality Rate (per 1000 Persons), 1960-2019",),
       caption = expression("Limited to reporting countries")) + 
  ylab("Crude Mortality Rate (per 1000 Persons)")
```

## US-specific Data

### Disasters

#### Source

[Click here to be redirected to the direct source for this dataset](https://www.ncdc.noaa.gov/billions/time-series)

#### Code

```{r}
us_disaster <- read_csv(here("docs/time-series-US.csv"), skip = 2)

us_disaster <- us_disaster %>%
  dplyr::select(Year,
                `Drought Count`,
                `Flooding Count`,
                `Freeze Count`,
                `Severe Storm Count`,
                `Tropical Cyclone Count`,
                `Wildfire Count`,
                `Winter Storm Count`)

sapply(us_disaster, class)

us_disaster <- us_disaster %>%
  mutate(`Disasters` = rowSums(.[2:dim(.)[2]])) %>%
  dplyr::select(Year,
                `Disasters`) %>%
  mutate(Country="United States") %>%
  gather(key = Indicator, value = Value, -Country, -Year) %>%
  mutate(Region="United States",
         Type="US-specific")
```

### Temperature

#### Source

[Click here to be redirected to the direct source for this dataset](https://www.ncdc.noaa.gov/cag/national/time-series/)

#### Code

```{r}
us_temperature <- read_csv(here("docs/temperature.txt"),skip=4,na="-99")

sapply(us_temperature, class)

us_temperature <- us_temperature %>%
  dplyr::select(-Anomaly) %>%
  mutate(Date = substr(Date, start = 1, stop = 4)) %>%
  mutate(Country="United States",
         Year = Date,
         Indicator="Temperature (Fahrenheit)",
         Region="United States",
         Type="US-specific") %>%
  dplyr::select(-Date, )
```

## Analysis dataframe

```{r}
colnames(CO2_emissions)
colnames(gdp_growth)
colnames(energy_use)
colnames(mortality)

df_wide <- CO2_emissions %>%
  full_join(gdp_growth, by=c("Country", "Year")) %>%
  full_join(energy_use, by=c("Country", "Year")) %>%
  full_join(mortality, by=c("Country", "Year"))

df_long <- df_wide %>%
  gather(key=Indicator,value=Value,-Country, -Year) %>%
  mutate(Region=case_when(Country=="United States" ~ "United States",
                          Country!="United States" ~ "Rest of the World"),
         Type="Global")

setequal(sapply(df_long, class),sapply(us_disaster, class))
setequal(sapply(df_long, class),sapply(us_temperature, class))

df_long <- df_long %>%
  rbind(us_disaster) %>%
  rbind(us_temperature)

sapply(df_long,class)

df_long$Country <- as.factor(df_long$Country)
df_long$Year <- as.numeric(df_long$Year)

sapply(df_long,class)

df_long <- df_long %>%
  filter(complete.cases(.)) %>%
  arrange(Country)
```

```{r, eval=FALSE}
ggplot(df_long, aes(x=Year, y=Value, group=Country)) +
  geom_line(alpha=0.2) + 
  facet_grid(Indicator~., scales = "free_y") +
  ylab("Indicator Value") + 
  labs(title="Distribution of Indicators by Year and Value")
```

## Subsetting the data

```{r}
df_long %>%
  filter(Type=="Global") %>%
  group_by(Year,Indicator) %>%
  tally() %>%
  ggplot(aes(x=Year, y=n, color=Indicator)) +
  geom_vline(xintercept = 1980, linetype=2, color="black") +
  geom_vline(xintercept = 2010, linetype=2, color="black") +
  geom_line() +
  labs(title = "Countries with Complete Data per Year",
       subtitle = "Global Data") + 
  ylab("Countries") + 
  scale_x_continuous(breaks = seq(1750,2020,by=10),
                     labels = seq(1750,2020,by=10)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x = element_blank(),
        legend.position = "bottom")

df_long %>%
  filter(Region=="United States") %>%
  group_by(Indicator) %>%
  summarise(Start=min(Year), End=max(Year)) %>%
  ggplot(aes(x=Indicator, y=End)) +
  geom_hline(yintercept = 1980, linetype=2, color="black") +
  geom_hline(yintercept = 2010, linetype=2, color="black") +
  geom_segment(aes(x=Indicator,
                   xend=Indicator,
                   yend=End,
                   y=Start)) +
  geom_point(aes(x=Indicator, y=Start), shape=16, color="black") +
  geom_point(aes(x=Indicator, y=End), shape=21, fill="white", color="black") + 
  coord_flip() +
  labs(title = "Complete Data per Year",
       subtitle = "US-specific Data") + 
  ylab("Countries") + 
  scale_y_continuous(breaks = seq(1750,2020,by=10),
                     labels = seq(1750,2020,by=10)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank())
```

```{r, Animation_1, warning=FALSE, eval=FALSE}
animation_1 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Deaths/1000 People") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region,alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme(axis.text.x = element_text(angle = 90)) + 
  theme_classic() +
  ylab("Crude Mortality Rate") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_1, fps = 10, duration = 5)
```

```{r, Animation_2, warning=FALSE, eval=FALSE}
animation_2 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Energy Use (kg, oil-eq./capita)") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region, alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) + 
  ylab("Energy Use per Capita") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_2, fps = 10, duration = 5)
```

```{r, Animation_3, warning=FALSE, eval=FALSE}
animation_3 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="GDP Growth/Capita (%)") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region, alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("GDP Growth per Capita (%)") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_3, fps = 10, duration = 5)
```

```{r, Animation_4, warning=FALSE, eval=FALSE}
animation_4 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="CO2 Emissions (Mg)") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region, alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("CO2 Emissions (Mg)") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_4, fps = 10, duration = 5)
```

```{r}
Top10<-df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="CO2 Emissions (Mg)") %>%
  filter(Year>=1900) %>%
  filter(Year<=2010) %>%
  group_by(Country) %>%
  mutate(max_val = max(Value)) %>%
  ungroup() %>%
  mutate(rank=dense_rank(-max_val)) %>%
  filter(rank<=10) %>%
  ggplot(aes(x=Year, y=fct_reorder(Country, Value, max))) +
  geom_tile(color="transparent", aes(fill=log(Value))) +
  scale_fill_gradientn(colors = c("yellow","red","black")) +
  scale_x_continuous(breaks = seq(1900,2010,by=5),
                     labels = seq(1900,2010,by=5)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank(),
        legend.position = "bottom") + 
  labs(title = "Top 10 Emissions-producing Countries in 2010 (1900-2010)",
       subtitle = "Ordered by Emissions Produced in 2010",
       fill = "Ln(CO2 Emissions (Mg))")

Top10
```

## US-specific

```{r}
df_long_us <- df_long %>%
  filter(Country=="United States")

# Approximated derivative function)
df_long_us <- df_long_us %>%
  filter(Year>=1900,
         Year<=2010) %>%
  group_by(Indicator) %>%
  mutate("Change (%)"=((Value/lag(Value))*100)-100,
         Mean=mean(Value),
         Anomaly=Value-Mean) %>%
  ungroup() %>%
  mutate(Anomaly_color=ifelse(Anomaly>0,"Positive",
                              ifelse(Anomaly<0,"Negative","Zero")),
         Anomaly_color=factor(Anomaly_color, levels = c("Positive",
                                                        "Negative",
                                                        "Zero"),
                              ordered = TRUE))
```

```{r}
US_Indicators<-df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value)) + 
  geom_line() + 
  facet_wrap(Indicator~., ncol=2, nrow=3, scales = "free_y") + 
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.y = element_blank()) + 
  labs(title = "US-specific Indicators (1980-2010)")
US_Indicators
```

```{r}
df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=`Change (%)`, color=Indicator, fill="transparent")) + 
  geom_hline(yintercept=0.8, linetype=2) +
  geom_hline(yintercept=1.2, linetype=2) +
  geom_hline(yintercept = 1, linetype=3) +
  geom_line(size=0.5) + 
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) +
  scale_y_continuous(breaks = seq(-500,1250, by=250),
                     labels = seq(-500,1250, by=250)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "US-specific Indicators (1980-2010)",
       subtitle = "Change (%) Lines")

df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  filter(Indicator=="Temperature (Fahrenheit)"|
           Indicator=="Energy Use (kg, oil-eq./capita)"|
           Indicator=="CO2 Emissions (Mg)") %>%
  ggplot(aes(x=Year, y=`Change (%)`, color=Indicator)) + 
  geom_hline(yintercept=0.8, linetype=2) +
  geom_hline(yintercept=1.2, linetype=2) +
  geom_hline(yintercept = 1, linetype=3) +
  geom_line(size=1) +
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) +
  scale_y_continuous(breaks = seq(-10,10, by=1),
                     labels = seq(-10,10, by=1),
                     limits = c(-10,10)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "Emissions, Energy Use, and Temperature (1980-2010)",
       subtitle = "Change (%) Lines")

df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  filter(Indicator=="Temperature (Fahrenheit)"|
           Indicator=="Energy Use (kg, oil-eq./capita)"|
           Indicator=="CO2 Emissions (Mg)") %>%
  ggplot(aes(x=Year, y=`Change (%)`, color=Indicator)) + 
  geom_hline(yintercept=0.8, linetype=2) +
  geom_hline(yintercept=1.2, linetype=2) +
  geom_hline(yintercept = 1, linetype=3) +
  geom_smooth(size=1, alpha=0.1, aes(fill=Indicator), se=FALSE) +
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) +
  scale_y_continuous(breaks = seq(-10,10, by=1),
                     labels = seq(-10,10, by=1),
                     limits = c(-10,10)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "US Emissions, Energy Use, and Temperatures (1980-2010)",
       subtitle = "Smoothed Change (%) Lines")
```

```{r}
df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  filter(Indicator=="CO2 Emissions (Mg)"|
           Indicator=="Temperature (Fahrenheit)") %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_line() + 
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) + 
  facet_wrap(Indicator~., scales = "free_y", ncol=1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank()) + 
  labs(title="US Emissions and Temperatures (1980-2010)")

df_long_us %>%
  filter(Indicator=="CO2 Emissions (Mg)"|
           Indicator=="Temperature (Fahrenheit)") %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_vline(xintercept = 1980, linetype=2, color="black") + 
  geom_vline(xintercept = 2010, linetype=2, color="black") +
  geom_segment(aes(x=Year, y=Value, xend=Year, yend=Mean,color=Anomaly_color), size=1.25) +
  scale_color_manual(values = c("red","blue","gray")) + 
  geom_hline(aes(yintercept=Mean), linetype=1, color="black") +
  scale_x_continuous(breaks = seq(1900,2010,by=5),
                     labels = seq(1900,2010,by=5)) +
  facet_wrap(Indicator~., scales = "free_y", ncol=1) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank(),
        legend.position = "none")  +
  labs(title = "US Emissions and Temperatures (1900-2010)",
       subtitle = "Indicator Mean Represented by Solid Black Line")
```

```{r}
df_long_us %>%
  filter(Indicator=="Temperature (Fahrenheit)"|
           Indicator=="CO2 Emissions (Mg)") %>%
  ggplot(aes(x=Year, y=`Change (%)`)) +
  annotate("rect", xmin=-Inf, xmax=Inf, ymin=0, ymax=Inf, alpha=0.25, fill="green") +
  annotate("rect", xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=0, alpha=0.25, fill="red") +
  geom_hline(yintercept=0, linetype=1) + 
  geom_segment(aes(x=Year, y=`Change (%)`, xend=Year, yend=0), size=1.25) +
  facet_wrap(Indicator~., scales = "free_y", ncol=1) +
  scale_x_continuous(breaks = seq(1900,2010,by=5),
                     labels = seq(1900,2010,by=5)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "US Emissions, Energy Use, and Temperatures (1980-2010)",
       subtitle = "Change (%) Lines")
```

Main plot

```{r}

library(patchwork)

CO2_world + Top10 + US_Indicators +
  plot_layout(widths = c(1, 2), heights = unit(c(2, 5), c('cm', 'null')))

png(here::here("img", "mainplot.png"), width = 900, height = 700)
(CO2_world | Top10)/ US_Indicators+
    plot_layout(widths = c(1, 2), heights = unit(c(4, 5), c('cm', 'null')))
dev.off()
```


