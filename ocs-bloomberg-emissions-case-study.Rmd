---
title: "Open Case Studies : CO2 Emissions Over Time"
author: "Michael Ontiveros, Carrie Wright, PhD."
css: style.css
output:
  html_document:
    self_contained: yes
    code_download: yes
    highlight: tango
    number_sections: no
    theme: cosmo
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

<style>
#TOC {
  background: url("https://opencasestudies.github.io/img/logo.jpg");
  background-size: contain;
  padding-top: 240px !important;
  background-repeat: no-repeat;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, comment = NA, echo = TRUE,
                      message = FALSE, warning = FALSE, cache = FALSE,
                      fig.align = "center", out.width = '90%')
library(here)
library(knitr)
```

#### {.outline }
```{r, echo = FALSE, out.width = "800 px"}
knitr::include_graphics(here::here("img", "mainplot.png"))
```

####

## {.disclaimer_block}

**Disclaimer**: The purpose of the [Open Case Studies](https://opencasestudies.github.io){target="_blank"} project is **to demonstrate the use of various data science methods, tools, and software in the context of messy, real-world data**. A given case study does not cover all aspects of the research process, is not claiming to be the most appropriate way to analyze a given data set, and should not be used in the context of making policy decisions without external consultation from scientific experts. 

## **Motivation**
*** 

This case study explores how different countries have contributed to Carbon Dioxide (CO2) emissions over time and how CO2 emission rates may relate to increasing global temperatures and increased rates of natural disasters and storms. This report provides a basis for the motivation: https://www.epa.gov/report-environment/greenhouse-gases.


CO2 makes up the largest proportion of greenhouse gas emissions in the United States:


```{r, echo = FALSE, out.width="500px"}
knitr::include_graphics(here::here("img", "emissions.jpg"))
```

A variety of sources and sectors contribute to greenhouse gas emissions, with transportation contributing the most metric tons of CO2:


```{r, echo = FALSE, out.width="600px"}
knitr::include_graphics(here::here("img", "sector.png"))
```

So why should we pay attention to greenhouse gases?

According to the [US Environmental Protection Agency (EPA) Inventory of U.S. Greenhouse Gas Emissions and Sinks 2020 Report](https://www.epa.gov/ghgemissions/inventory-us-greenhouse-gas-emissions-and-sinks): 

> Greenhouse gases absorb infrared radiation, thereby trapping heat in the atmosphere and making the planet warmer. The most important greenhouse gases directly emitted by humans include carbon dioxide (CO2), methane (CH4), nitrous oxide (N2O), and several fluorine-containing halogenated substances. Although CO2, CH4, and N2O occur naturally in the atmosphere, human activities have changed their atmospheric concentrations. From the pre- industrial era (i.e., ending about 1750) to 2018, concentrations of these greenhouse gases have increased globally by 46, 165, and 23 percent, respectively (IPCC 2013; NOAA/ESRL 2019a, 2019b, 2019c). 

* IPCC stands for the Intergovernmental Panel on Climate Change

There are many signs that our planet is experiencing warmer temperatures:

```{r, echo = FALSE, out.width="600px"}
knitr::include_graphics(here::here("img", "warming.png"))
```

The connection between greenhouse gas levels and global temperatures and the influence of increased global temperatures on human health are motivated by these reports:

#### {.reference_block}

Melillo, J.M., T.C. Richmond, and G.W. Yohe (eds.). 2014. Climate change impacts in the United States: The third National Climate Assessment. U.S. Global Change Research Program.  

2020. “Inventory of US Greenhouse Gas Emissions and Sinks: 1990--2018.” EPA 430-R-20-002, Tech. Rep. https://www.epa.gov/ghgemissions/inventory-us-greenhouse-gas-emissions-and-sinks.


####

The National Climate Assessment Report states that:

> Heat-trapping gases already in the atmosphere have committed us to a hotter future with more climate-related impacts over the next few decades. The magnitude of climate change beyond the next few decades depends primarily on the amount of heat-trapping gases that human activities emit globally, now and in the future.

See [here](https://www.epa.gov/report-environment/greenhouse-gases) and [here](https://world101.cfr.org/global-era-issues/climate-change/climate-change-adaptations) for more information.

## **Main Questions**
*** 

#### {.main_question_block}
<b><u> Our main question: </u></b>

1) How have global CO2 emission rates changed over time? In particular for the US, and how does the US compare to other countries? 
2) Are US CO2 emissions, global temperatures, and US storm rates associated? 

####

## **Learning Objectives** 
*** 

In this case study, we will explore CO2 emission data from around the world. We will also focus on the US specifically to evaluate patterns of temperatures and storm activity. This case study will particularly focus on how to use different datasets that span different ranges of time, as well as how to create visualizations of patterns over time. We will especially focus on using packages and functions from the [`Tidyverse`](https://www.tidyverse.org/){target="_blank"}, such as `dplyr`, `tidyr`, `plotly`and `gganimate`. The tidyverse is a library of packages created by RStudio. While some students may be familiar with previous R programming packages, these packages make data science in R especially efficient.


*** 


We will begin by loading the packages that we will need:

```{r}
library(here)
library(readxl)
library(readr)
library(dplyr)
library(magrittr)
library(tidyverse)
library(plotly)
library(ggplot2)
library(gganimate)
library(ggrepel)
library(RColorBrewer)
```


 Package   | Use                                                                         
---------- |-------------
[here](https://github.com/jennybc/here_here){target="_blank"}       | to easily load and save data
[readxl](https://readxl.tidyverse.org/){target="_blank"}  | to import the excel file data
[readr](https://readr.tidyverse.org/){target="_blank"}  | to import the csv file data
[dplyr](https://dplyr.tidyverse.org/){target="_blank"}  |  to view and wrangle the data
[magrittr](https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html){target="_blank"}  |  to use and reassign data objects using the `%<>%`pipe operator
[tidyverse](https://www.tidyverse.org/packages/){target="_blank"}  | to wrangle the data and create ggplot2 plots
[plotyly](https://plotly.com/r/){target="_blank"}  | to make the visualizations
[ggplot2](https://ggplot2.tidyverse.org/){target="_blank"} | to make visualizations
[ggrepel](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html){target="_blank"} | to add labels that don't overlap to plots
[gganimate](https://gganimate.com/){target="_blank"}  | to make the plots interactive
[RColorBrewer](https://cran.r-project.org/web/packages/RColorBrewer/index.html){target="_blank"}  | to have greater control over the color in our plots

The first time we use a function, we will use the `::` to indicate which package we are using. Unless we have overlapping function names, this is not necessary, but we will include it here to be informative about where the functions we will use come from.


## **Context**
*** 

Greenhouse gas emissions are due to both natural processes and anthropogenic (human-derived) activities. 

These emissions are one of the contributing factors to rising global temperatures, which can have a great influence on [public health](https://www.epa.gov/climate-indicators/understanding-connections-between-climate-change-and-human-health){target="_blank"}  as illustrated in the following image:

```{r, echo = FALSE, out.width="800px"}
knitr::include_graphics(here::here("img", "health.png"))
```

> Gases in the atmosphere can contribute to climate change both directly and indirectly. Direct effects occur when the gas itself absorbs radiation. Indirect radiative forcing occurs when chemical transformations of the substance produce other greenhouse gases, when a gas influences the atmospheric lifetimes of other gases, and/or when a gas affects atmospheric processes that alter the radiative balance of the earth (e.g., affect cloud formation or albedo). The IPCC developed the Global Warming Potential (GWP) concept to compare the ability of a greenhouse gas to trap heat in the atmosphere relative to another gas.
The GWP of a greenhouse gas is defined as the ratio of the accumulated radiative forcing within a specific time horizon caused by emitting 1 kilogram of the gas, relative to that of the reference gas CO2 (IPCC 2013). Therefore GWP-weighted emissions are provided in million metric tons of CO2 equivalent (MMT CO2 Eq.)


 CO2 is actually the least capable of the greenhouse gases for trapping heat:

```{r, echo = FALSE, out.width="800px"}
knitr::include_graphics(here::here("img", "GWP.png"))
```

However, because CO2 is so much more abundant and stays in the atmosphere so much longer than other greenhouse gases, it has been the largest contributor to global warming.

See [here](https://www.ucsusa.org/resources/why-does-co2-get-more-attention-other-gases#:~:text=CO2%20sticks%20around,oxide%20(N2O){target="_blank"}.)
for more details.


Furthermore, sizing CO2 levels also influence ocean acidity:

```{r, echo = FALSE, out.width="500px"}
knitr::include_graphics(here::here("img", "oceans.png"))
```

This makes it difficult for organisms to maintain their shells or skeletons that are made of calcium carbonate, thus making it more difficult for these organisms to survive and impacting their role in the ecosystem and food chain. 


Furthermore, greenhouse gas emissions are believed to influence storm rates. 

Indeed events with high levels of precipitation which can induce flooding and property damage are generally increasing around the country:

```{r, echo = FALSE, out.width="500px"}
knitr::include_graphics(here::here("img", "storms.png"))
```


## **Limitations**
*** 

There are some important considerations regarding this data analysis to keep in mind: 

1) Correlation or association does not imply causation 

2) Limitaiton 2  






## **What are the data?**
*** 

In this case study we will be using data related to CO2 emissions, as well as other data that may influence, be influenced or relate to CO2 emissions. Most of our data was obtained from [Gapminder](https://www.gapminder.org/data/){target="_blank"}, which is a unique nonprofit that provides a variety of data for free.

In their words, Gapminder is...

> Gapminder is an independent Swedish foundation with no political, religious or economic affiliations. Gapminder is a fact tank, not a think tank. Gapminder fights devastating misconceptions about global development. Gapminder produces free teaching resources making the world understandable based on reliable statistics. Gapminder promotes a fact-based worldview everyone can understand.  Gapminder collaborates with universities, UN, public agencies and non-governmental organizations. All Gapminder activities are governed by the board. We do not award grants. Gapminder Foundation is registered at Stockholm County Administration Board. Our constitution can be found [here](https://www.gapminder.org/about-gapminder/constitution/).

The data that we will be using from Gapminder was obtained from the [World Bank](https://www.worldbank.org/en/what-we-do){target="_blank"}.


In addition we will use some data that is specific to the United States from the [National Oceanic and Atmospheric Administration (NOAA)] (https://www.noaa.gov/), which is an agency that collects weather and climate data.


Data   | Time span | Source  | Orginal Source   | Description | Citation                                                                    
---------- |-------------|-------------|-------------|--------|-------
**CO2 emissions**  |1751 to 2014 | [Gapminder](https://www.gapminder.org/data/){target="_blank"}  | [Carbon Dioxid Information Analysis Center (CDIAC)](https://cdiac.ess-dive.lbl.gov/){target="_blank"}  |  CO2 emissions in tonnes or metric tons (equivalent to approximately 2,204.6 pounds) per person by country| NA
**GDP per capita, yearly growth** | 1801 to 2019| [Gapminder](https://www.gapminder.org/data/){target="_blank"}  | [World Bank](https://data.worldbank.org/indicator/NY.GDP.PCAP.KD.ZG){target="_blank"}  |  [Growth Domestic Product](https://www.investopedia.com/terms/g/gdp.asp#:~:text=Gross%20Domestic%20Product%20(GDP)%20is%20the%20monetary%20value%20of%20all,expenditures%2C%20production%2C%20or%20incomes.){target="_blank"}  (which is an overall measure of the health of nation's economy) per person by country| NA
**Energy use per person** |1960 to 2015 | [Gapminder](https://www.gapminder.org/data/){target="_blank"}  | [World Bank](https://data.worldbank.org/indicator/EG.USE.PCAP.KG.OE){target="_blank"}  |  Use of primary energy before transformation to other end-use fules, by country | NA
**Crude Mortality Rate** |1960 to 2018 | [World Bank](https://data.worldbank.org/indicator/SP.DYN.CDRT.IN){target="_blank"}  | [World Bank](https://data.worldbank.org/indicator/SP.DYN.CDRT.IN){target="_blank"} |  Death rate per 1,000 people by country | NA 
**US Natural Disasters** | 1980 to 2019 | [The National Oceanic and Atmospheric Administration (NOAA)](https://www.ncdc.noaa.gov/billions/time-series){target="_blank"}| [The National Oceanic and Atmospheric Administration (NOAA) ](https://www.ncdc.noaa.gov/billions/time-series){target="_blank"}|  US data about: <br> -- Droughts <br> -- Floods <br> -- Freezes <br> -- Severe Storms <br> -- Tropical Cyclones <br> -- Wildfires<br> -- Winter Storms | NOAA National Centers for Environmental Information (NCEI) U.S. Billion-Dollar Weather and Climate Disasters (2020). https://www.ncdc.noaa.gov/billions/, DOI: 10.25921/stkw-7w73
**Temperature**  | 1895 to 2019|  [The National Oceanic and Atmospheric Administration (NOAA)](https://www.ncdc.noaa.gov/cag/national/time-series){target="_blank"}  | [The National Oceanic and Atmospheric Administration (NOAA)](https://www.ncdc.noaa.gov/cag/national/time-series){target="_blank"} | US National yearly average temperature (in Fahrenheit) from 1895 to 2019 | NOAA National Centers for Environmental information, Climate at a Glance: National Time Series, published June 2020, retrieved on June 26, 2020 from https://www.ncdc.noaa.gov/cag/


To obtain the temperature data, annual average temperatures were selected as shown in this image:
```{r, echo = FALSE, out.width = "800 px"}
knitr::include_graphics(here::here("img", "temp.png"))
```


Importantly, notice that the data we would like to use span different time periods:

Data   | Time span                                                                     
---------- |-------------
**CO2 emissions**  |1751 to 2014 
**GDP per capita, yearly growth** | 1801 to 2019
**Energy use per person** |1960 to 2015 
**Crude Mortality Rate** |1960 to 2018 
**US Natural Disasters** | 1980 to 2019 
**Temperature**  | 1895 to 2019




## **Data Import**
*** 

To read in the files that were downloaded from the various sources as indicated in the table above, we will use the `read_xlsx()` and `read_xls()` functions of the `readxl` package to import the data from the .xlsx and .xls files respectively and we will use the `read_csv` function of the `readr` package to import the data from the csv files.

```{r}
# xlsx files:
CO2_emissions <- readxl::read_xlsx(here("docs/yearly_co2_emissions_1000_tonnes.xlsx"))
gdp_growth <- readxl::read_xlsx(here("docs/gdp_per_capita_yearly_growth.xlsx"))
energy_use <- readxl::read_xlsx(here("docs/energy_use_per_person.xlsx"))

# xls file:
mortality <- readxl::read_xls(here("docs/API_SP.DYN.CDRT.IN_DS2_en_excel_v2_804384.xls"))
```

For our csv data files, there are some lines that we would like to not import - infact, we will get an error if we try to import them because our table structure will be as r expects. We can do so using the `skip =` argument of the `read_csv()` function. 

Here you can see that the first two rows of the data about US Disasters doesn't have the same number of columns as the subsequent rows. So we want to skip these first two lines, we will use `skip = 2` for this.

```{r, echo = FALSE, out.width = "800 px"}
knitr::include_graphics(here::here("img", "Disasters.png"))
```
Now looking at the temperature data, we can see that  the first four lines do not have the same number of columns as the subsequent lines. We will skip importing all 4 lines by using `skip = 4`. We can also specify that `NA` values are encoded as `"-99"`. This will replace all instances of `"-99"` with `NA`. We can do this using the `na = ` argument of the `read_csv()` function. We will do so as: `na = "-99"`. The "-99" needs to be in quotation markes becuase this argument expects characters.

```{r, echo = FALSE, out.width = "800 px"}
knitr::include_graphics(here::here("img", "tempdata.png"))
```

```{r}
#csv files:
us_disaster <- readr::read_csv(here("docs/time-series-US.csv"), skip = 2)
us_temperature <- readr::read_csv(here("docs/temperature2.csv"), skip = 4, na ="-99")
```

Great! now we have imported all of the data that we will need.


## **Data Exploration and Wrangling**
*** 

Now we will take a look at our data and wrangle it until it is easy to use to allow us to evaluate how CO2 emissions have changed over time and how emissions may relate to energy use, mortality, GDP etc. 

### Yearly CO~2~ Emissions

First let's take a look at the CO2 data. We can use the base `head()` function to see just the first 6 rows of our data.

We will use the `%>%` pipe which can be used to define the input for later sequential steps. This will make more sense when we have multiple sequential steps using the same data object. To use the pipe notation we need to install and load  the `dplyr` package.

```{r}
CO2_emissions %>%
  head()
```

OK, we can see that our country data makes of the rows and the yearly data makes up the columns. We also see that we have alot of `NA` values.


We can also use the `glimpse()` function of the `dplyr` packge to view our data. This allows us to see more of our data at once. We will see a tiny bit of each variable/column. To do so our data will be displayed with the column names listed on the right.

#### {.scrollable }
```{r}
# Scroll through the output!
CO2_emissions %>%
dplyr::glimpse()
```
####


  Indicator                           n
  <chr>                           <int>
1 CO2 Emissions (Mg)              57246
2 Deaths/1000 People              57246
3 Disasters                          40
4 Energy Use (kg, oil-eq./capita) 57246
5 GDP Growth/Capita (%)           57246
6 Temperature (Fahrenheit)          116


We can see that we have a large [tibble](https://tibble.tidyverse.org/). A tibble is the tidyverse version of a data frame. It is essentially a table with variable information arranged as columns, and individual observations arranged as rows. We can see that the tibble gives us information about the class of each variable.  For example the `country` variable is made up of character (abbreviated as chr) values. We see that we have 265 different country variables and CO2 emission values for 192 different years (from 1751 to 2014). Recall that the values are emissions in metric tons also called tonnes. We can see that there are fewer `NA` values for later years.

Now we will modify this data to make it more usable for making visualizations. One thing we will use is the `%<>%` opperator which is from the `magrittr` package. This allows us to use our `CO2_emissions` data and reassign it to a modified version at the same time. 

We will use the `pivot_longer()` function of the `dplyr` package to convert our data into what is called long format. This means that we will have more rows and fewer columns than our current format. This is done by collapsing multiple variables into fewer variables.

We want to collapse all of the values for the emission data across the different individual year variables into one new emission variable and we will identify what year they are from using a new `Year` variable.

```{r}
CO2_emissions  %<>%
  pivot_longer(cols = -country, names_to = "Year", values_to = "Emissions")

head(CO2_emissions)
```

We also want to rename the `country` variable to be capitalized. W We can use the `rename()` function of the `dplyr` package to rename this variable. When renaming variables the new name is listed first before the `=`. We will also modify the `Emissions` data by dividing it by 1000 to make the numbers smaller. To do this we will use the `mutate()` function, which is also part of the `dplyr()` package. This function allows us to create and modify variables. You may also note that the `Year` variable is currently of class type character. We would like to change it to be numeric. This can also be accomplished using the `mutate()` function.

```{r}
  
 CO2_emissions  %<>% 
   dplyr::rename(Country=country) %>%
   dplyr::mutate(Emissions = Emissions/1000, 
          Year = as.numeric(Year))
     #rename(`CO2 Emissions (Mg)`= Emissions)

```

Now let's take a look to see how our data has changed:

```{r}

CO2_emissions %>%
head()

```
Great, we can see that now the `Year` variable is of class double (abbreviated `dbl`), which is a numeric class.

### Yearly Growth in GDP per Capita

```{r}
gdp_growth %>%
  head()
```

```{r}
names(gdp_growth)
```

#### {.scrollable}
```{r}
# Scroll through the output!
gdp_growth %>%
glimpse()
```
####

Again, we will use the `pivot_longer()` to transform the data to long format. We will also again change the `country` variable to be `Country` by using the `rename()` function , and we will make the `Year` varaible numeric using the `mutate()` function. 

AVOCADO... this was in Michael's code... but I don't know that we need it
We will use the `drop_na()` function of the `tidyr` package to drop all years with missing data.

```{r}
# gdp_growth %<>%
#    tidyr::drop_na()
# 
# head(gdp_growth)
```

```{r}
gdp_growth %<>%
  pivot_longer(cols = -country, 
               names_to = "Year", 
               values_to = "gdp_growth") %>%
  rename(Country=country) %>%
  mutate(Year =as.numeric(Year)) %>%
  #  tidyr::drop_na() %>% # not sure we need this..
  rename(`GDP Growth/Capita (%)` = gdp_growth)
```

Now let's see how this data has changed:

```{r}
gdp_growth %>%
  head()

gdp_growth %>%
  count(Year)
```

### Energy Use per Person

Now let's take a look at the energy use per person data:

```{r}
energy_use %>%
  head()
```

#### {.scrollable}
```{r}
energy_use %>%
  glimpse()
```
####

To wrangle the `energy_use` data, we will again convert the data to long format, rename some variables, and mutate the `Year` data to be numeric.

```{r}
energy_use %<>%
  pivot_longer(cols = -country, names_to = "Year", values_to = "energy_use") %>%
  rename(Country=country) %>%
  mutate(Year = as.numeric(Year)) %>%
  rename(`Energy Use (kg, oil-eq./capita)` = energy_use)

```

#### {.scrollable}
```{r}
# Scroll through the output!
energy_use %>%
glimpse()
```
####

### Crude Mortality Rate

```{r}
mortality %>%
  head()
```


We can see that there are a couple of empty rows which indicate when the data was updated.
We can also see that the columns really start at the 3rd row. So first we will repace the column names with the 3rd row. Then we will remove the first 3 rows.

```{r}
colnames(mortality)
colnames(mortality) <- mortality[3,]
colnames(mortality)
mortality <- mortality[-c(1:3),]
```



#### {.scrollable}
```{r}
mortality %>%
  glimpse()

```
####


That is looking better! However, we also want to remove some variables like: `Country Code`, `Indicator Name`, and `Indicator Code`. We can do that using the `select()` functio of the `dplyr` package. We can use the minus sign `-` to indicate what variables we dont want to keep. Otherwise, we will perform similar modifications as we performed on the other datasets.

```{r}
mortality %<>%
  select(-`Country Code`,
         -`Indicator Name`,
         -`Indicator Code`) %>%
  rename(Country = "Country Name") %>%
  pivot_longer(cols = -Country, 
               names_to = "Year", 
               values_to = "Deaths/1000 People") %>%
  mutate(Year = as.numeric(Year)) %>%
  mutate(`Deaths/1000 People` = as.numeric(`Deaths/1000 People`))

```

```{r}
mortality %>%
  head()
```


## US-specific Data
Now we will take a look at the US data about disasters and temperature.

### Disasters

```{r}
us_disaster  %>%
  head()
```

We are specifically interested in the `Year` and  the variables that contain the word `"Count"` so we will select them using the `select()` and `contains()` functions in the `dplyr` package. Since we are selecting for variables with the word `"Count"` we need to use quotation marks around it. Selecting for the variable `year` does not require this as that is actually the name of one of the existing variables.


```{r}
us_disaster %<>%
           select(Year, contains("Count"))

us_disaster %>%
  head()
```

Now we want to create a new variable that will be the sum of all the different types of disasters for each year. 

We can create this ne variable using the `mutate()` function of `dplyr` and we will use the base `rowSums()` function to perform the calculation. We dont want to include the `Year` variable in our sum, so we can exclude it using the `select`function within the `rowSums()` function. However, to do so we need to indicate that we are using the data that we already used as input to our `mutate()` and `rowSums()` functions. We can do so by using a `.`. 


```{r}
us_disaster %<>%
  mutate(`Disasters` = rowSums(select(., -Year))) 

us_disaster %>%
  glimpse()
```

Great, now we are going to remove some of these variables and just keep or select using the `select()` function the variables we are interested in. We will keep the `Flooding Count` becuase as you may recall from earlier in this case study, events of extreme perciptation levels appear to be associated with global warming. We will use this as a proxy for that.

AVOCADO why is US listed in 3 variables?
We are also going to add a new variable called `Country` to indicate that this data is from the United States. This will create a new variable where every value is `United States`. We will also create a new variable called `Region` where every value is `US-specific` and a new variable called `Type` where every value is `United States`.

```{r}
us_disaster %<>%
  dplyr::select(Year,
                Disasters) %>%
  mutate(Country = "United States") %>%
  pivot_longer(cols = c(-Country, - Year),
               names_to = "Indicator",
               values_to = "Value") %>%
  mutate(Region = "United States",
           Type = "US-specific")

head(us_disaster)
```



### Temperature

```{r}
us_temperature %>%
  head()
```
OK, so we want to remove the `Anomaly` variable which is an indicator of how different the national average temperature for that year was from the average temperature from 1901-2000 which was 52.02&deg;F. 

We also want to change the date values, which are currently listed as the year followed by the number 12. To do so we want to just keep the first 4 characters in the `Date` variable string values. We can use the `str_sub()` function of the `stringr` package to do this. We just need to indicate the start and stop characters. In this case the start would be 1 and the 4th character would be where we want to stop, so we would use `start = 1, stop = 4`. Again we will create a `Country`, `Region` and `Type` variable. We will also change the name of the `Date` variable to `Year` so that it will be consistent with our other datasets. Furthermore, we also what it to be numeric. We can accomplish both renaming and changing to numeric by using the `mutate()` function. We canthen remove the `Date` variable and also order the columns just like the other us data using the `select()` function.

```{r}
us_temperature %<>%
  dplyr::select(-Anomaly) %>%
  mutate(Date = str_sub(Date, start = 1, end = 4))%>%
  rename() %>%
  mutate(Year = as.numeric(Date), 
      Country = "United States",
    Indicator = "Temperature (Fahrenheit)",
       Region = "United States",
         Type = "US-specific") %>%
  select(Year, Country, Indicator,  Value, Region, Type)

head(us_temperature)
```

## Joining data

Now we would like to join the different datasets together into one tibble. To do so it is often necessary to have at least one column or variable with the same name to be used as a key for putting your data together. To put all of our data together there are several `*_join()` functions available in the `dplyr` package. 


```{r, echo = FALSE, out.width = "800 px"}
knitr::include_graphics(here::here("img", "join.png"))
```

We will use the `full_join()` function as we have different time spans for each dataset and we would like to retain as much data as possible. The`full_join()` function will simply create `NA` values for any of the years that are not in one of the data sets. We can check by using the base `summary()` function. This will also allow us to check that there are column names that are consistent in each dataset that we wish to combine.

```{r}
summary(CO2_emissions)
summary(gdp_growth)
summary(energy_use)
summary(mortality)

```

Indeed, `Country`, and `Year` variables are present in all of the datasets. We can see that the minimum and maximum year is different for nearly all the datasets.

We need to specify what columns/variables we will be joining by using the `by =` argument in the `full_join()` function.

```{r}

df_wide <- CO2_emissions %>%
  full_join(gdp_growth, by = c("Country", "Year")) %>%
  full_join(energy_use, by = c("Country", "Year")) %>%
  full_join(mortality, by = c("Country", "Year"))

df_wide %>%
  head()
```

We can also do the same thing using by using the`reduce()` function of the `purrr` package. This is a good option if you have many dasasets to combine.


```{r}
df_wide <- list(CO2_emissions, 
                gdp_growth, 
                energy_use, 
                mortality) %>% 
  reduce(full_join, by = c("Country", "Year"))

df_wide %>%
  head()
```

```{r}
df_wide %>%
  glimpse()
```

Nice, looks good!

We will also make a long version of this data, where we will create an new variable called `Indicator` that will indicate what dataset the data came from and we will collapse the values from the columns called ` Emissions`, (`CO2 Emissions (Mg)`), `GDP Growth/Capita (%)`, `Energy Use (kg, oil-eq./capita)`, and `Deaths/1000 People`. 


```{r}
df_long <- df_wide %>%
  pivot_longer(cols = c(-Country, -Year), 
               names_to = "Indicator", 
               values_to = "Value")
head(df_long)
```

We will also create a new variable called `Region` that will indicate if the data is about the United States or a different country based on the values in the `Country` variable. We will use the `case_when()` function of the `dplyr` package to do this. If the `Country` variable is equal to `"United States"` the value for the new variable will also be "United States", where as if the `Country` variable is not equal to `"United States"` but is some other character string value, such as `"Afghanistan"`, then the value for the new variable will be `"Rest of the World"`.
The new values for the new variable `Region` are indicated after the specific conditional statements by using the `~` symbol. We will also create a new variable called `Type`, where all the values are `"Global"` to indicate that this data is not specific to just the United States. 


```{r}
 df_long %<>%
  mutate(Region = case_when(Country=="United States" ~ "United States",
                          Country!="United States" ~ "Rest of the World"),
         Type = "Global")
head(df_long)
```

We will now combine this data with the US data about disasters and temperatures.

We will now use the `bind_rows()` function which will just append the `us_temperature` data and the `us_disaster` data after the `df_long` data. 


```{r}
head(us_disaster)
head(us_temperature)

df_long <-list(df_long, 
               us_disaster,
               us_temperature) %>%
  bind_rows()
df_long$Country <- as.factor(df_long$Country)
```

We can check the top and bottom of the new `df_long` tibble to see that our `us_temperature` data is at the bottom.

```{r}
head(df_long)
tail(df_long)
```


<details> <summary> Click here for details about the difference between `full_join()` and `bind_rows()` </summary>

The difference between this function and the `full_join()` function is that the `bind_rows()` function will assentially just append each dataset to each other, whereas the `full_join()` function collapses data that is comparable. Here you will see an example of what the data would have been like for `df_wide` if we had made it using `bind_rows()`.

```{r}
df_wide_br <- list(CO2_emissions, 
                gdp_growth, 
                energy_use, 
                mortality) %>% 
  bind_rows()

dim(df_wide)
dim(df_wide_br)

df_wide%>%
  filter(Country == "China", Year == "1960")

df_wide_br%>%
  filter(Country == "China", Year == "1960")
```
</detials>


AVOCADO Hmmm the top plot changes completely if we drop countries with na values... 
```{r}
df_long_with_miss <- df_long %>%
  arrange(Country)

df_long<- df_long %>%
  filter(complete.cases(.)) %>%
  arrange(Country)


head(df_long_with_miss)
head(df_long)

```




## **Data Exploration**
*** 
Now we will create some simple plots to examine the data.

### CO2 Emissions (1751-2014)

We can check the time span of this data by refering back to the  [**What are the data?**] section.

```{r}

# CO2_emissions %>%
#   # rename(`CO2 Emissions (Mg)`= Emissions) %>%
# ggplot(aes(x=Year, y=`CO2 Emissions (Mg)`, group=Country)) +
#   geom_line(alpha=0.2) + 
#   labs(title = expression("Country CO"[2]*" Emissions per Year , 1751-2014"),
#        caption = expression("Limited to reporting countries")) + 
#   ylab("Emissions (1M Metric Tonnes)")
# 
# CO2_world<-CO2_emissions %>%
#  # rename(`CO2 Emissions (Mg)`= Emissions) %>%
#   group_by(Year) %>%
#   summarise(`CO2 Emissions (Mg)` = sum(`CO2 Emissions (Mg)`, na.rm = TRUE)) %>%
#   ggplot(aes(x=Year, y=`CO2 Emissions (Mg)`)) +
#   geom_line() + 
#   labs(title = expression("World CO"[2]*" Emissions per Year , 1751-2014"),
#        caption = expression("Limited to reporting countries")) + 
#   ylab("Emissions (1M Metric Metric Tonnes)")
# CO2_world

df_long %>%
  filter(Indicator == "Emissions") %>%
  ggplot(aes(x=Year, y= Value, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country CO"[2]*" Emissions per Year , 1751-2014"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Emissions (1M Metric Tonnes)")

CO2_world<-df_long %>%
  filter(Indicator == "Emissions",
         Year <= 2014) %>%
  group_by(Year) %>%
  summarise(Value = sum(Value, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_line(size = 1.5) + 
  labs(title = expression("World CO"[2]*" Emissions per Year , 1751-2014"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Emissions (1M Metric Metric Tonnes)")+
  theme_linedraw()
CO2_world

```


### Yearly Growth in GDP per Capita (1801 to 2019)

```{r}
# ggplot(gdp_growth, aes(x=Year, y=`GDP Growth/Capita (%)`, group=Country)) +
#   geom_line(alpha=0.2) + 
#   labs(title = expression("Country GDP Growth per Capita per Year (Annual %), 1801-2019"),
#        caption = expression("Limited to reporting countries")) + 
#   ylab("GDP Growth per Capita (Annual %)")
# 
# gdp_growth %>%
#   group_by(Year) %>%
#   summarise(`GDP Growth/Capita (%)` = mean(`GDP Growth/Capita (%)`, na.rm = TRUE)) %>%
#   ggplot(aes(x=Year, y=`GDP Growth/Capita (%)`)) +
#   geom_line() + 
#   labs(title = expression("Mean Country GDP Growth per Capita per Year (Annual %), 1801-2019"),
#        caption = expression("Limited to reporting countries")) + 
#   ylab("GDP Growth per Capita (Annual %)")

df_long %>%
  filter(Indicator == "GDP Growth/Capita (%)", 
         Year >= 1801) %>%
ggplot(aes(x=Year, y=Value, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country GDP Growth per Capita per Year (Annual %), 1801-2019"),
       caption = expression("Limited to reporting countries")) + 
  ylab("GDP Growth per Capita (Annual %)")

df_long %>%
  filter(Indicator == "GDP Growth/Capita (%)",
         Year >= 1801) %>%
  group_by(Year) %>%
  summarise(Value = mean(Value, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_line() + 
  labs(title = expression("Mean Country GDP Growth per Capita per Year (Annual %), 1801-2019"),
       caption = expression("Limited to reporting countries")) + 
  ylab("GDP Growth per Capita (Annual %)")
```

### Energy Use per Person (1960 to 2015)

```{r}
# ggplot(energy_use, aes(x=Year, y=`Energy Use (kg, oil-eq./capita)`, group=Country)) +
#   geom_line(alpha=0.2) + 
#   labs(title = expression("Country Energy Use (kg of Oil Equivalent per Capita), 1960 to 2015",),
#        caption = expression("Limited to reporting countries")) + 
#   ylab("Energy Use (kg of Oil Equivalent per Capita)")
# 
# energy_use %>%
#   group_by(Year) %>%
#   summarise(`Energy Use (kg, oil-eq./capita)` = sum(`Energy Use (kg, oil-eq./capita)`, na.rm = TRUE)) %>%
#   ggplot(aes(x=Year, y=`Energy Use (kg, oil-eq./capita)`)) +
#   geom_line() + 
#   labs(title = expression("Worldwide Energy Use (kg of Oil Equivalent per Capita), 1960 to 2015"),
#        caption = expression("Limited to reporting countries")) + 
#   ylab("Energy Use (kg of Oil Equivalent per Capita)")


df_long %>%
  filter(Indicator == "Energy Use (kg, oil-eq./capita)",
              Year >= 1960, 
              Year <= 2015) %>%
ggplot(aes(x=Year, y= Value, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country Energy Use (kg of Oil Equivalent per Capita), 1960 to 2015",),
       caption = expression("Limited to reporting countries")) + 
  ylab("Energy Use (kg of Oil Equivalent per Capita)")

df_long %>%
  filter(Indicator == "Energy Use (kg, oil-eq./capita)",
              Year >= 1960, 
              Year <= 2015) %>%
  group_by(Year) %>%
  summarise(Value = sum(Value, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_line() + 
  labs(title = expression("Worldwide Energy Use (kg of Oil Equivalent per Capita), 1960 to 2015"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Energy Use (kg of Oil Equivalent per Capita)")
```

### Crude Mortality Rate


```{r}

df_long %>%
  filter(Indicator == "Deaths/1000 People",
              Year >= 1960, 
              Year <= 2019) %>%
  ggplot(aes(x=Year, y=Value, group=Country)) +
  geom_line(alpha=0.2) + 
  labs(title = expression("Country Crude Mortality Rate (per 1000 Persons), 1960 to 2019"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Crude Mortality Rate (per 1000 Persons)")


df_long %>%
  filter(Indicator == "Deaths/1000 People",
              Year >= 1960, 
              Year <= 2019) %>%
   group_by(Year) %>%
  summarise(Value = mean(Value, na.rm = TRUE)) %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_line() + 
  labs(title = expression("Mean Country Crude Mortality Rate (per 1000 Persons), 1960 to 2019"),
       caption = expression("Limited to reporting countries")) + 
  ylab("Crude Mortality Rate (per 1000 Persons)")
  
```

## US-specific Data

### Disasters

```{r}

df_long %>%
  filter(Indicator == "Disasters",
              Year >= 1980, 
              Year <= 2019) %>%
  ggplot(aes(x=Year, y=Value, group=Country)) +
  geom_line() + 
  geom_smooth(method = "lm") +
  labs(title = expression("US Disasters, 1980 to 2019"),
       subtitle = expression("Drougths, Floods, Freezes, Severe Storms. Tropical Cyclones, Wildfires, and Winter Storms")) + 
  ylab("Disaster Count")
  
```

### Temperature

```{r}

df_long %>%
  filter(Indicator == "Temperature (Fahrenheit)",
              Year >= 1895, 
              Year <= 2019) %>%
  ggplot(aes(x=Year, y=Value, group=Country)) +
  geom_line() + 
  geom_smooth(method = "lm") +
  labs(title = expression("US Average Annual Temperature, 1895 to 2019"))+
  ylab("Temperature (Fahrenheit)")

```


## Data Visualization


Now Let's try putting the data together. 

```{r, eval=FALSE}
ggplot(df_long, aes(x=Year, y=Value, group=Country)) +
  geom_line(alpha=0.2) + 
  facet_grid(Indicator~., scales = "free_y") +
  ylab("Indicator Value") + 
  labs(title="Distribution of Indicators by Year and Value")
```

## Time spans of data

```{r}
df_long %>%
  filter(Type == "Global") %>%
  group_by(Year, Indicator, .drop=FALSE) %>%
  tally() %>%
  ggplot(aes(x= Year, y = n, color = Indicator)) +
  geom_line() +
    geom_vline(xintercept = 1980, linetype=2, color="black") +
   geom_vline(xintercept = 2014, linetype=2, color="black") +
  labs(title = "Countries with Complete Data per Year",
       subtitle = "Global Data") + 
  ylab("Countries") + 
  scale_x_continuous(breaks = seq(1750,2020,by=10),
                     labels = seq(1750,2020,by=10)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x = element_blank(),
        legend.position = "bottom")

df_long %>%
  filter(Region=="United States") %>%
  group_by(Indicator) %>%
  summarise(Start=min(Year), End=max(Year)) %>%
  ggplot(aes(x=Indicator, y=End)) +
  geom_hline(yintercept = 1980, linetype=2, color="black") +
  geom_hline(yintercept = 2014, linetype=2, color="black") +
  geom_segment(aes(x=Indicator,
                   xend=Indicator,
                   yend=End,
                   y=Start)) +
  geom_point(aes(x=Indicator, y=Start), shape=16, color="black") +
  geom_point(aes(x=Indicator, y=End), shape=21, fill="white", color="black") + 
  coord_flip() +
  labs(title = "Complete Data per Year",
       subtitle = "US-specific Data") + 
  ylab("Countries") + 
  scale_y_continuous(breaks = seq(1750,2020,by=10),
                     labels = seq(1750,2020,by=10)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank())
```

```{r, Animation_1, warning=FALSE, eval=FALSE}
animation_1 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Deaths/1000 People") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region,alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme(axis.text.x = element_text(angle = 90)) + 
  theme_classic() +
  ylab("Crude Mortality Rate") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_1, fps = 10, duration = 5)
```

```{r, Animation_2, warning=FALSE, eval=FALSE}
animation_2 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Energy Use (kg, oil-eq./capita)") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region, alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) + 
  ylab("Energy Use per Capita") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_2, fps = 10, duration = 5)
```

```{r, Animation_3, warning=FALSE, eval=FALSE}
animation_3 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="GDP Growth/Capita (%)") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region, alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("GDP Growth per Capita (%)") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_3, fps = 10, duration = 5)
```

```{r, Animation_4, warning=FALSE, eval=FALSE}
animation_4 <- df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Emissions") %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value, group=Country, color=Region, size=Region, alpha=Region)) +
  geom_point() +
  scale_color_manual(values = c("Red","Black")) +
  scale_alpha_manual(values = c(0.1, 1)) +
  scale_size_manual(values = c(0.25, 2)) +
  labs(title="Distribution of Indicators by Year and Value, 1980-2010") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("CO2 Emissions (Mg)") +
  transition_time(as.integer(Year)) +
  shadow_wake(wake_length = 1, alpha = FALSE)

animate(animation_4, fps = 10, duration = 5)
```

To color our plot we will use the viridis color pallette which is compatible with color-blindness by using the `scale_fill_viridis_c()` function which is simply available by loading the `ggplot2` package.There are a few variations such as discreet as `_d`, or binned continuous as `_b`. The `_c` indicates a continuous scale. See [here](https://ggplot2.tidyverse.org/reference/scale_viridis.html) for more information.

```{r}
Top10<-df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Emissions") %>%
  filter(Year>=1900) %>%
  filter(Year<=2014) %>%
  group_by(Country) %>%
  mutate(max_val = max(Value)) %>%
  ungroup() %>%
  mutate(rank=dense_rank(-max_val)) %>%
  filter(rank<=10) %>%
  ggplot(aes(x=Year, y=fct_reorder(Country, Value, max))) +
  geom_tile(color="transparent", aes(fill=log(Value))) +
   # scale_fill_gradientn(colors = c("red","black")) +
  scale_fill_viridis_c()+
 # scale_fill_gradientn(colors = c("yellow","red","black")) +
  scale_x_continuous(breaks = seq(1900,2014,by=5),
                     labels = seq(1900,2014,by=5)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank(),
        legend.position = "bottom") + 
  labs(title = "Top 10 Emissions-producing Countries in 2010 (1900-2014)",
       subtitle = "Ordered by Emissions Produced in 2014",
       fill = "Ln(CO2 Emissions (Mg))")

Top10
```
Interestingly, we can see that Germany had ver low imission rates at the end of World War II. We see that the US has consistently had high emission rates since 1900, but that the emission rates in China recently surpased that of the US.
```{r}

Top10b<-df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Emissions") %>%
  filter(Year>=1900) %>%
  filter(Year<=2014) %>%
  group_by(Country) %>%
  mutate(max_val = max(Value)) %>%
  ungroup() %>%
  mutate(rank=dense_rank(-max_val)) %>%
  filter(rank<=10) %>%
  ggplot(aes(x=Year, y=Value, color = Country)) +
geom_line() +  # scale_fill_gradientn(colors = c("red","black")) +
  scale_color_viridis_d()+
  geom_text_repel(data = df_long %>%
  filter(Type=="Global") %>%
  filter(Indicator=="Emissions") %>%
  filter(Year>=1900) %>%
  filter(Year<=2014) %>%
  group_by(Country) %>%
  mutate(max_val = max(Value)) %>%
  ungroup() %>%
  mutate(rank=dense_rank(-max_val)) %>%
  filter(rank<=10) %>%
              filter(Year == last(Year)),
            aes(label = Country,
                x = Year,
                y = Value),
            size = 3,
            alpha = 1,
            nudge_x = 10,
            direction = "y",
            hjust = 1,
            vjust = 1,
            segment.size = 0.25,
            segment.alpha = 0.25,
            force = 1)+
  theme_linedraw() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank(),
        legend.position = "none") + 
  labs(title = "Top 10 Emissions-producing Countries in 2010 (1900-2014)",
       subtitle = "Ordered by Emissions Produced in 2014",
       fill = "Ln(CO2 Emissions (Mg))")

Top10b


```
## US-specific

```{r}
df_long_us <- df_long %>%
  filter(Country=="United States")

# Approximated derivative function)
df_long_us <- df_long_us %>%
  filter(Year >= 1900,
         Year <= 2010) %>%
  group_by(Indicator) %>%
  mutate("Change (%)"=((Value/lag(Value))*100)-100,
         Mean=mean(Value),
         Anomaly=Value-Mean) %>%
  ungroup() %>%
  mutate(Anomaly_color=ifelse(Anomaly>0,"Positive",
                              ifelse(Anomaly<0,"Negative","Zero")),
         Anomaly_color=factor(Anomaly_color, levels = c("Positive",
                                                        "Negative",
                                                        "Zero"),
                              ordered = TRUE))
```

```{r}
US_Indicators <- df_long %>%
  filter(Country=="United States")%>%
#US_Indicators<-df_long_us %>%
  filter(Year>=1980) %>%
 # filter(Year<=2010) %>%
  ggplot(aes(x=Year, y=Value)) + 
  geom_line() + 
  geom_smooth(method = "loess") +
  facet_wrap(Indicator~., ncol=2, nrow=3, scales = "free_y") + 
  #scale_x_continuous(breaks = seq(1980,2010,by=5),
  #                   labels = seq(1980,2010,by=5)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.y = element_blank()) + 
  labs(title = "US-specific Indicators")
US_Indicators
```

```{r}
df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2014) %>%
  ggplot(aes(x=Year, y=`Change (%)`, color=Indicator, fill="transparent")) + 
  geom_hline(yintercept=0.8, linetype=2) +
  geom_hline(yintercept=1.2, linetype=2) +
  geom_hline(yintercept = 1, linetype=3) +
  geom_line(size=0.5) + 
  scale_x_continuous(breaks = seq(1980,2014,by=5),
                     labels = seq(1980,2014,by=5)) +
  scale_y_continuous(breaks = seq(-500,1250, by=250),
                     labels = seq(-500,1250, by=250)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "US-specific Indicators (1980-2010)",
       subtitle = "Change (%) Lines")

df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2014) %>%
  filter(Indicator=="Temperature (Fahrenheit)"|
           Indicator=="Energy Use (kg, oil-eq./capita)"|
           Indicator=="Emissions") %>%
  ggplot(aes(x=Year, y=`Change (%)`, color=Indicator)) + 
  geom_hline(yintercept=0.8, linetype=2) +
  geom_hline(yintercept=1.2, linetype=2) +
  geom_hline(yintercept = 1, linetype=3) +
  geom_line(size=1) +
  scale_x_continuous(breaks = seq(1980,2014,by=5),
                     labels = seq(1980,2014,by=5)) +
  scale_y_continuous(breaks = seq(-10,10, by=1),
                     labels = seq(-10,10, by=1),
                     limits = c(-10,10)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "Emissions, Energy Use, and Temperature (1980-2010)",
       subtitle = "Change (%) Lines")

df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  filter(Indicator=="Temperature (Fahrenheit)"|
           Indicator=="Energy Use (kg, oil-eq./capita)"|
           Indicator=="Emissions") %>%
  ggplot(aes(x=Year, y=`Change (%)`, color=Indicator)) + 
  geom_hline(yintercept=0.8, linetype=2) +
  geom_hline(yintercept=1.2, linetype=2) +
  geom_hline(yintercept = 1, linetype=3) +
  geom_smooth(size=1, alpha=0.1, aes(fill=Indicator), se=FALSE) +
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) +
  scale_y_continuous(breaks = seq(-10,10, by=1),
                     labels = seq(-10,10, by=1),
                     limits = c(-10,10)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "US Emissions, Energy Use, and Temperatures (1980-2010)",
       subtitle = "Smoothed Change (%) Lines")
```

```{r}
df_long_us %>%
  filter(Year>=1980) %>%
  filter(Year<=2010) %>%
  filter(Indicator=="Emissions"|
           Indicator=="Temperature (Fahrenheit)") %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_line() + 
  scale_x_continuous(breaks = seq(1980,2010,by=5),
                     labels = seq(1980,2010,by=5)) + 
  facet_wrap(Indicator~., scales = "free_y", ncol=1) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank()) + 
  labs(title="US Emissions and Temperatures (1980-2010)")

df_long_us %>%
  filter(Indicator=="Emissions"|
           Indicator=="Temperature (Fahrenheit)") %>%
  ggplot(aes(x=Year, y=Value)) +
  geom_vline(xintercept = 1980, linetype=2, color="black") + 
  geom_vline(xintercept = 2010, linetype=2, color="black") +
  geom_segment(aes(x=Year, y=Value, xend=Year, yend=Mean,color=Anomaly_color), size=1.25) +
  scale_color_manual(values = c("red","blue","gray")) + 
  geom_hline(aes(yintercept=Mean), linetype=1, color="black") +
  scale_x_continuous(breaks = seq(1900,2010,by=5),
                     labels = seq(1900,2010,by=5)) +
  facet_wrap(Indicator~., scales = "free_y", ncol=1) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.title = element_blank(),
        legend.position = "none")  +
  labs(title = "US Emissions and Temperatures (1900-2010)",
       subtitle = "Indicator Mean Represented by Solid Black Line")
```

```{r}
df_long_us %>%
  filter(Indicator=="Temperature (Fahrenheit)"|
           Indicator=="Emissions") %>%
  ggplot(aes(x=Year, y=`Change (%)`)) +
  annotate("rect", xmin=-Inf, xmax=Inf, ymin=0, ymax=Inf, alpha=0.25, fill="green") +
  annotate("rect", xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=0, alpha=0.25, fill="red") +
  geom_hline(yintercept=0, linetype=1) + 
  geom_segment(aes(x=Year, y=`Change (%)`, xend=Year, yend=0), size=1.25) +
  facet_wrap(Indicator~., scales = "free_y", ncol=1) +
  scale_x_continuous(breaks = seq(1900,2010,by=5),
                     labels = seq(1900,2010,by=5)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x  = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal") + 
  labs(title = "US Emissions, Energy Use, and Temperatures (1980-2010)",
       subtitle = "Change (%) Lines")
```

## Main plot

```{r}

library(patchwork)

CO2_world + Top10 + US_Indicators +
  plot_layout(widths = c(1, 2), heights = unit(c(2, 5), c('cm', 'null')))

png(here::here("img", "mainplot.png"), width = 900, height = 700)
(CO2_world | Top10)/ US_Indicators+
    plot_layout(widths = c(1, 2), heights = unit(c(4, 5), c('cm', 'null')))
dev.off()
```


